var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ChessBoardBed=function(t){function e(e){var i=t.call(this)||this;e&&(i._reverse=!0);var s=RES.getRes("board_png");return i.texture=s,i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_TAP,i.ontap,i),i}return __extends(e,t),e.prototype.gene_sites_points=function(){this.place_board();var t,e,i,s;this._reverse?(t=this.x+this.width/2-22,e=this.y+this.height/2-23,i=-57,s=-57):(t=this.x-this.width/2+22,e=this.y-this.height/2+23,i=57,s=57),this.sites_points=new Array;for(var o=0;9>o;o++){this.sites_points[o]=new Array;for(var n=0;10>n;n++)this.sites_points[o][n]=[t+o*i,e+n*s]}},e.prototype.place_board=function(){this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this._reverse&&(this.rotation=180),this.x=this.parent.stage.stageWidth/2,this.y=this.parent.stage.stageHeight/2},e.prototype.ontap=function(t){var e=new CheInpEvt(CheInpEvt.Tap);this.parent.dispatchEvent(e)},e}(egret.Bitmap);__reflect(ChessBoardBed.prototype,"ChessBoardBed");var AI=function(){function t(t,e,i){void 0===i&&(i="b"),this.Map=t,this.pieces_set=e,this.AI_faction=i,this.treeDepth=4,this.gene_VALUE_set()}return t.prototype.arr2clone=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i].slice();return e},t.prototype.gene_VALUE_set=function(){this.VALUE_set={r:{},b:{}},this.VALUE_set.r.c=[[206,206,206,206,208,208,204,198,200,194],[208,212,208,213,211,212,209,208,208,206],[207,209,207,213,211,212,204,204,206,204],[213,216,214,216,214,214,212,212,212,212],[214,233,216,216,215,215,214,212,200,200],[213,216,214,216,214,214,212,212,212,212],[207,209,207,213,211,212,204,204,206,204],[208,212,208,213,211,212,209,208,208,206],[206,206,206,206,208,208,204,198,200,194]],this.VALUE_set.r.m=[[90,90,92,93,90,90,92,93,85,88],[90,96,98,108,100,98,94,92,90,85],[90,103,99,100,99,101,98,94,92,90],[96,97,103,107,103,102,95,95,93,88],[90,94,99,100,104,103,98,92,78,90],[96,97,103,107,103,102,95,95,93,88],[90,103,99,100,99,101,98,94,92,90],[90,96,98,108,100,98,94,92,90,85],[90,90,92,93,90,90,92,93,85,88]],this.VALUE_set.r.x=[[0,0,18,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[20,0,0,0,20,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,23,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],this.VALUE_set.r.s=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[20,0,20,0,0,0,0,0,0,0],[0,23,0,0,0,0,0,0,0,0],[20,0,20,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],this.VALUE_set.r.j=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[8888,8888,8888,0,0,0,0,8888,8888,8888],[8888,8888,8888,0,0,0,0,8888,8888,8888],[8888,8888,8888,0,0,0,0,8888,8888,8888],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],this.VALUE_set.r.p=[[100,98,97,96,96,95,96,97,96,96],[100,98,97,99,96,96,96,96,97,96],[96,96,96,99,96,99,96,100,98,97],[91,92,91,98,96,96,96,99,98,99],[90,89,92,100,100,100,96,101,98,99],[91,92,91,98,96,96,96,99,98,99],[96,96,96,99,96,99,96,100,98,97],[100,98,97,99,96,96,96,96,97,96],[100,98,97,96,96,95,96,97,96,96]],this.VALUE_set.r.z=[[9,19,19,19,14,7,7,0,0,0],[9,24,24,23,18,0,0,0,0,0],[9,34,32,27,20,13,7,0,0,0],[11,42,37,29,27,16,15,0,0,0],[13,44,37,30,29,16,15,0,0,0],[11,42,37,29,27,16,15,0,0,0],[9,34,32,27,20,13,7,0,0,0],[9,24,24,23,18,0,0,0,0,0],[9,19,19,19,14,7,7,0,0,0]];for(var t in this.VALUE_set.r){for(var e=this.arr2clone(this.VALUE_set.r[t]),i=0,s=e;i<s.length;i++){var o=s[i];o.reverse()}this.VALUE_set.b[t]=e}},t.prototype.getMoves=function(t,e){t||(t=this.Map),e||(e=this.AI_faction);for(var i=new Array,s=0;s<t.length;s++)for(var o=0;o<t[s].length;o++){var n=t[s][o];if(n){var r=this.pieces_set[n];if(r.get_property("p_faction")==e){r.effect_update(t,this.pieces_set);for(var h=0,_=r.get_property("landing_points");h<_.length;h++){var a=_[h];i.push({move_id:n,oldX:s,oldY:o,newX:a[0],newY:a[1]})}}}}return i},t.prototype.getEvaluate=function(t,e){t||(t=this.Map),e||(e=this.AI_faction);for(var i=0,s=0;s<t.length;s++)for(var o=0;o<t[s].length;o++)if(t[s][o]){var n=this.pieces_set[t[s][o]],r=n.get_property("p_role"),h=n.get_property("p_faction"),_=this.VALUE_set[h][r][s][o];h==e?i+=_:i-=_}return i},t.prototype.getAlphaBeta=function(t,e,i,s,o){if(0==i)return{value:this.getEvaluate(s,o)};for(var n=this.getMoves(s,o),r=0,h=n;r<h.length;r++){var _=h[r],a=s[_.newX][_.newY];if(s[_.newX][_.newY]=_.move_id,s[_.oldX][_.oldY]=null,this.pieces_set[_.move_id].move(_.newX,_.newY),a&&"j"==this.pieces_set[a].get_property("p_role"))return s[_.oldX][_.oldY]=_.move_id,s[_.newX][_.newY]=a,this.pieces_set[_.move_id].move(_.oldX,_.oldY),{move_id:_.move_id,oldX:_.oldX,oldY:_.oldY,newX:_.newX,newY:_.newY,value:8888};var c=void 0,p=this.getAlphaBeta(-e,-t,i-1,s,"r"==o?"b":"r");if(c=p?-p.value:null,s[_.oldX][_.oldY]=_.move_id,s[_.newX][_.newY]=a,this.pieces_set[_.move_id].move(_.oldX,_.oldY),c>=e)return{move_id:_.move_id,oldX:_.oldX,oldY:_.oldY,newX:_.newX,newY:_.newY,value:e};if(c>t&&(t=c,this.treeDepth==i))var v={move_id:_.move_id,oldX:_.oldX,oldY:_.oldY,newX:_.newX,newY:_.newY,value:t}}return this.treeDepth==i?v?v:!1:{value:t}},t.prototype.oneAImove=function(t,e,i){return t||(t=this.treeDepth),e||(e=this.Map),i||(i=this.AI_faction),this.getAlphaBeta(-99999,99999,t,this.arr2clone(e),i)},t}();__reflect(AI.prototype,"AI");var history_record=function(){function t(){}return t}();__reflect(history_record.prototype,"history_record");var LogicPiece=function(){function t(t,e,i,s,o){this.living=!0,o&&(this.p_id=o),this.m_x=i,this.m_y=s,this.p_role=t,this.p_faction=e}return t.prototype.set_p_id=function(t){this.p_id=t},t.prototype.get_property=function(t){var e;switch(t){case"m_x":e=this.m_x;break;case"m_y":e=this.m_y;break;case"p_role":e=this.p_role;break;case"p_faction":e=this.p_faction;break;case"p_id":e=this.p_id;break;case"living":e=this.living;break;case"landing_points":e=this.landing_points;break;case"menace_pieces":e=this.menace_pieces;break;default:return null}return e},t.prototype.effect_update=function(t,e){if(t[this.m_x][this.m_y]!=this.p_id)for(var i=0;i<t.length;i++)for(var s=0;s<t[i].length;s++)if(t[i][s]==this.p_id){this.move(i,s);break}var o=[],n=[],r=[0,0,8,9],h=r[0],_=r[1],a=r[2],c=r[3],p=[0,4,5,9],v=p[0],l=p[1],d=p[2],f=p[3];switch(this.p_role){case"c":for(var i=this.m_x-1;i>=h;i--){var u=t[i][this.m_y];if(u){e[u].p_faction!=this.p_faction&&(o.push([i,this.m_y]),n.push(u));break}o.push([i,this.m_y])}for(var i=this.m_x+1;a>=i;i++){var u=t[i][this.m_y];if(u){e[u].get_property("p_faction")!=this.p_faction&&(o.push([i,this.m_y]),n.push(u));break}o.push([i,this.m_y])}for(var s=this.m_y-1;s>=_;s--){var u=t[this.m_x][s];if(u){e[u].p_faction!=this.p_faction&&(o.push([this.m_x,s]),n.push(u));break}o.push([this.m_x,s])}for(var s=this.m_y+1;c>=s;s++){var u=t[this.m_x][s];if(u){e[u].p_faction!=this.p_faction&&(o.push([this.m_x,s]),n.push(u));break}o.push([this.m_x,s])}break;case"m":for(var m=[[this.m_x+1,this.m_y-2,this.m_x,this.m_y-1],[this.m_x+2,this.m_y-1,this.m_x+1,this.m_y],[this.m_x+2,this.m_y+1,this.m_x+1,this.m_y],[this.m_x+1,this.m_y+2,this.m_x,this.m_y+1],[this.m_x-1,this.m_y+2,this.m_x,this.m_y+1],[this.m_x-2,this.m_y+1,this.m_x-1,this.m_y],[this.m_x-2,this.m_y-1,this.m_x-1,this.m_y],[this.m_x-1,this.m_y-2,this.m_x,this.m_y-1]],y=0,g=m;y<g.length;y++){var E=g[y];if(!(E[0]<h||E[0]>a||E[1]<_||E[1]>c||t[E[2]][E[3]])){var u=t[E[0]][E[1]];u?e[u].p_faction!=this.p_faction&&(o.push([E[0],E[1]]),n.push(u)):o.push([E[0],E[1]])}}break;case"p":for(var w=!1,i=this.m_x-1;i>=h;i--){var u=t[i][this.m_y];if(w){if(u){e[u].p_faction!=this.p_faction&&(o.push([i,this.m_y]),n.push(u));break}}else u?w=!0:o.push([i,this.m_y])}w=!1;for(var i=this.m_x+1;a>=i;i++){var u=t[i][this.m_y];if(w){if(u){e[u].p_faction!=this.p_faction&&(o.push([i,this.m_y]),n.push(u));break}}else u?w=!0:o.push([i,this.m_y])}w=!1;for(var s=this.m_y-1;s>=_;s--){var u=t[this.m_x][s];if(w){if(u){e[u].p_faction!=this.p_faction&&(o.push([this.m_x,s]),n.push(u));break}}else u?w=!0:o.push([this.m_x,s])}w=!1;for(var s=this.m_y+1;c>=s;s++){var u=t[this.m_x][s];if(w){if(u){e[u].p_faction!=this.p_faction&&(o.push([this.m_x,s]),n.push(u));break}}else u?w=!0:o.push([this.m_x,s])}break;case"x":var x=void 0,T=void 0;"r"==this.p_faction?(x=v,T=l):(x=d,T=f);for(var C=[[this.m_x+2,this.m_y-2,this.m_x+1,this.m_y-1],[this.m_x+2,this.m_y+2,this.m_x+1,this.m_y+1],[this.m_x-2,this.m_y+2,this.m_x-1,this.m_y+1],[this.m_x-2,this.m_y-2,this.m_x-1,this.m_y-1]],I=0,A=C;I<A.length;I++){var E=A[I];if(!(E[0]<h||E[0]>a||E[1]<x||E[1]>T||t[E[2]][E[3]])){var u=t[E[0]][E[1]];u?e[u].p_faction!=this.p_faction&&(o.push([E[0],E[1]]),n.push(u)):o.push([E[0],E[1]])}}break;case"s":var b=[0,0,0,0],L=b[0],S=b[1],P=b[2],R=b[3];"r"==this.p_faction?(K=[3,5,0,2],L=K[0],S=K[1],P=K[2],R=K[3]):(q=[3,5,7,9],L=q[0],S=q[1],P=q[2],R=q[3]);for(var X=[[this.m_x+1,this.m_y+1],[this.m_x+1,this.m_y-1],[this.m_x-1,this.m_y+1],[this.m_x-1,this.m_y-1]],Y=0,M=X;Y<M.length;Y++){var E=M[Y];if(!(E[0]<L||E[0]>S||E[1]<P||E[1]>R)){var u=t[E[0]][E[1]];u?e[u].p_faction!=this.p_faction&&(o.push([E[0],E[1]]),n.push(u)):o.push([E[0],E[1]])}}break;case"z":var k=void 0,O=!1;"r"==this.p_faction?(k=1,this.m_y>l&&(O=!0)):(k=-1,this.m_y<d&&(O=!0));var F=void 0;F=O?[[this.m_x,this.m_y+k],[this.m_x-1,this.m_y],[this.m_x+1,this.m_y]]:[[this.m_x,this.m_y+k]];for(var D=0,U=F;D<U.length;D++){var E=U[D];if(!(E[0]<h||E[0]>a||E[1]<_||E[1]>c)){var u=t[E[0]][E[1]];u?e[u].p_faction!=this.p_faction&&(o.push([E[0],E[1]]),n.push(u)):o.push([E[0],E[1]])}}break;case"j":var B=[0,0,0,0],j=B[0],H=B[1],V=B[2],G=B[3];"r"==this.p_faction?(Q=[3,5,0,2],j=Q[0],H=Q[1],V=Q[2],G=Q[3]):(Z=[3,5,7,9],j=Z[0],H=Z[1],V=Z[2],G=Z[3]);for(var N=[[this.m_x+1,this.m_y],[this.m_x-1,this.m_y],[this.m_x,this.m_y+1],[this.m_x,this.m_y-1]],W=0,z=N;W<z.length;W++){var E=z[W];if(!(E[0]<j||E[0]>H||E[1]<V||E[1]>G)){var u=t[E[0]][E[1]];u?e[u].p_faction!=this.p_faction&&(o.push([E[0],E[1]]),n.push(u)):o.push([E[0],E[1]])}}if("r"==this.p_faction)for(var s=this.m_y+1;c>=s;s++){var u=t[this.m_x][s];if(u){var J=e[u];if("j"!=J.p_role)break;o.push([this.m_x,s]),n.push(u)}}else for(var s=this.m_y-1;s>=_;s--){var u=t[this.m_x][s];if(u){var J=e[u];if("j"!=J.p_role)break;o.push([this.m_x,s]),n.push(u)}}break;default:o=n=null}this.landing_points=o,this.menace_pieces=n;var K,q,Q,Z},t.prototype.move=function(t,e){this.m_x=t,this.m_y=e},t.prototype.kill_self=function(){this.living=!1},t.prototype.revive_self=function(){this.living=!0},t}();__reflect(LogicPiece.prototype,"LogicPiece");var LogicPlay=function(t){function e(e){var i=t.call(this)||this;return i.initMap=[[["c","r"],,,["z","r"],,,["z","b"],,,["c","b"]],[["m","r"],,["p","r"],,,,,["p","b"],,["m","b"]],[["x","r"],,,["z","r"],,,["z","b"],,,["x","b"]],[["s","r"],,,,,,,,,["s","b"]],[["j","r"],,,["z","r"],,,["z","b"],,,["j","b"]],[["s","r"],,,,,,,,,["s","b"]],[["x","r"],,,["z","r"],,,["z","b"],,,["x","b"]],[["m","r"],,["p","r"],,,,,["p","b"],,["m","b"]],[["c","r"],,,["z","r"],,,["z","b"],,,["c","b"]]],e&&i.bind(e),i}return __extends(e,t),e.prototype.bind=function(t){this.showplay=t},e.prototype.startone=function(){return this.showplay?void this.open_CS():(console.log("logic与show必须互相绑定"),0)},e.prototype.get_property=function(t){var e;switch(t){case"human_faction":e=this.human_faction;break;case"active_faction":e=this.active_faction;break;case"active_faction":e=this.active_faction;break;case"initMap":e=this.initMap;break;case"Map":e=this.Map;break;default:return null}return e},e.prototype.setInitChess=function(t){void 0===t&&(t="r"),this.Map=new Array,this.pieces_set={},this.CS_mode||(this.HistoryList=new Array),this.human_faction=t,this.change_faction("r");for(var e=0,i=0;i<this.initMap.length;i++){this.Map[i]=new Array;for(var s=0;s<this.initMap[i].length;s++){var o="p_"+e,n=this.initMap[i][s];if(n){var r=new LogicPiece(n[0],n[1],i,s,o);this.Map[i][s]=o,this.pieces_set[o]=r,e+=1}else this.Map[i][s]=null}}if(this.CS_mode){var h=this.human_faction;this.AI=new AI(this.Map,this.pieces_set,h)}else{var h="r"==this.human_faction?"b":"r";this.AI=new AI(this.Map,this.pieces_set,h)}this.phas_var={},this.phas_var.just_move_steps=0,this.CS_mode?this.addEventListener(CheInpEvt.Tap,this.reply_showplay_toCS,this):this.addEventListener(CheInpEvt.Tap,this.reply_showplay,this),this.showplay.startone(),console.log("客户端完成了自己的初始化",t)},e.prototype.adjust_show=function(){var t=new CheActEvt(CheActEvt.Act);t._adjust=!0,this.showplay.dispatchEvent(t)},e.prototype.open_CS=function(){this.CS_mode=!0,this.WS=new egret.WebSocket,this.WS.addEventListener(egret.Event.CONNECT,function(t){console.log("logicplay 与ws服务器取得了连接");var e={join:!0};this.WS.writeUTF(JSON.stringify(e)),this.WS.flush()},this),this.WS.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.reply_WS_toShow,this),this.WS.addEventListener(egret.Event.CLOSE,function(t){console.log("logicplay 与ws服务器连接断开了")},this),this.WS.connectByUrl("ws://192.168.1.102:2357/forChinessChess")},e.prototype.change_faction=function(t){var e=this;t?this.active_faction=t:"r"==this.active_faction?this.active_faction="b":this.active_faction="r",this.CS_mode||this.active_faction!=this.human_faction&&setTimeout(function(){e.ai_act()},100)},e.prototype.undo=function(){var t=this.HistoryList.pop();if(!t)return 0;var e=new CheActEvt(CheActEvt.Act);e._actPieceid=t.MovePieceId,e._moveToX=t.FromX,e._moveToY=t.FromY;var i=this.pieces_set[t.MovePieceId];if(this.Map[i.m_x][i.m_y]=null,i.move(t.FromX,t.FromY),this.Map[t.FromX][t.FromY]=t.MovePieceId,t.DiePieceId){var s=this.pieces_set[t.DiePieceId];s.revive_self(),e._revivePieceid=t.DiePieceId}this.showplay.dispatchEvent(e)},e.prototype.reply_showplay=function(t){var e=!1;if(t._reset){console.log("逻辑层收到了再来一局的请求"),this.startone();var i=new CheActEvt(CheActEvt.Act);return i._reset=!0,this.showplay.dispatchEvent(i),0}if(t._giveup){console.log("逻辑层收到了认输的请求");var s=new CheActEvt(CheActEvt.Act);return s._gameover=!0,s._winner="r"==this.active_faction?"b":"r",this.showplay.dispatchEvent(s),0}if(t._undo)return console.log("逻辑层收到了悔棋的请求"),this.undo(),this.undo(),0;if(!t._pieceID)return console.log("logicplay 接收到的CheInpEvt竟没有_pieceID",t),0;var o=new CheActEvt(CheActEvt.Act);if(null!=t._moveToX&&null!=t._moveToY){var n=this.pieces_set[t._pieceID];if(n.get_property("p_faction")!=this.active_faction)return console.log("逻辑层接收到来自表现层的非行动方行动请求，一定是bug，请检查"),o._invalid=!0,this.showplay.dispatchEvent(o),0;o._actPieceid=t._pieceID,o._invalid=!0,n.effect_update(this.Map,this.pieces_set);var r=n.get_property("landing_points");if(r){for(var h=!1,_=0,a=r;_<a.length;_++){var c=a[_];if(c[0]==t._moveToX&&c[1]==t._moveToY){h=!0;break}}if(h)if(this.Map[t._moveToX][t._moveToY]){var p=this.pieces_set[this.Map[t._moveToX][t._moveToY]];if(p.get_property("p_faction")!=n.get_property("p_faction")){o._moveToX=t._moveToX,o._moveToY=t._moveToY,o._dyingPieceid=this.Map[t._moveToX][t._moveToY],o._invalid=!1;var v=new history_record;v.ActFaction=this.active_faction,v.MovePieceId=n.get_property("p_id"),v.FromX=n.get_property("m_x"),v.FromY=n.get_property("m_y"),v.DiePieceId=p.get_property("p_id"),this.HistoryList.push(v),this.phas_var.just_move_steps=0,this.Map[v.FromX][v.FromY]=null,n.move(t._moveToX,t._moveToY),this.Map[t._moveToX][t._moveToY]=v.MovePieceId,o._change_faction=!0,e=!0,p.kill_self(),"j"==p.get_property("p_role")&&(o._gameover=!0,o._winner="r"==p.get_property("p_faction")?"b":"r")}}else{o._moveToX=t._moveToX,o._moveToY=t._moveToY,o._invalid=!1;var v=new history_record;if(v.ActFaction=this.active_faction,v.MovePieceId=n.get_property("p_id"),v.FromX=n.get_property("m_x"),v.FromY=n.get_property("m_y"),this.HistoryList.push(v),this.phas_var.just_move_steps+=1,this.phas_var.just_move_steps>8){var l=this.HistoryList.length-1;if(this.compare_records(this.HistoryList[l],this.HistoryList[l-4])&&this.compare_records(this.HistoryList[l],this.HistoryList[l-8])&&this.compare_records(this.HistoryList[l-1],this.HistoryList[l-5])&&this.compare_records(this.HistoryList[l-2],this.HistoryList[l-6])&&this.compare_records(this.HistoryList[l-3],this.HistoryList[l-7])){console.log("发现有磨棋行为"),o._gameover=!0;var d=this.AI.oneAImove(2,this.Map,this.active_faction);d?v.MovePieceId==d.move_id&&t._moveToX==d.newX&&t._moveToY==d.newY?(console.log("磨棋是因为除此无棋可走，和棋"),o._winner="no"):(console.log(this.active_faction,"方磨棋违规，判负"),o._winner="r"==this.active_faction?"b":"r"):(console.log("磨棋是因为无棋可走，和棋"),o._winner="no")}}this.Map[v.FromX][v.FromY]=null,n.move(t._moveToX,t._moveToY),this.Map[t._moveToX][t._moveToY]=v.MovePieceId,o._change_faction=!0,e=!0}}}else{var n=this.pieces_set[t._pieceID];n.effect_update(this.Map,this.pieces_set),o._actPieceid=n.get_property("p_id"),o._effectSites=n.get_property("landing_points"),o._invalid=!1}this.showplay.dispatchEvent(o),e&&this.change_faction()},e.prototype.reply_showplay_toCS=function(t){if(t._giveup||t._reset){var e={_giveup:!0};return this.WS.writeUTF(JSON.stringify(e)),this.WS.flush(),0}if(t._undo){var e={_undo:!0};return this.WS.writeUTF(JSON.stringify(e)),this.WS.flush(),0}if(!t._pieceID)return console.log("logicplay 接收到的CheInpEvt竟没有_pieceID",t),0;var i=this.pieces_set[t._pieceID];if(this.active_faction!=this.human_faction||this.active_faction!=i.get_property("p_faction")){var s=new CheActEvt(CheActEvt.Act);return s._invalid=!0,this.showplay.dispatchEvent(s),0}if(null!=t._moveToX&&null!=t._moveToY){var e={_pieceID:t._pieceID,_moveToX:t._moveToX,_moveToY:t._moveToY};return this.WS.writeUTF(JSON.stringify(e)),this.WS.flush(),0}i.effect_update(this.Map,this.pieces_set);var s=new CheActEvt(CheActEvt.Act);s._actPieceid=i.get_property("p_id"),s._effectSites=i.get_property("landing_points"),s._invalid=!1,this.showplay.dispatchEvent(s)},e.prototype.ai_act=function(){console.log("AI start!!");var t=this.AI.oneAImove();if(!t)return console.log("AI 不会走了 准备认输了"),0;var e=new CheInpEvt(CheInpEvt.Tap);e._pieceID=t.move_id,e._moveToX=t.newX,e._moveToY=t.newY,this.reply_showplay(e)},e.prototype.compare_records=function(t,e){return t.MovePieceId==e.MovePieceId&&t.FromX==e.FromX&&t.FromY==e.FromY?!0:!1},e.prototype.reply_WS_toShow=function(t){var e=this.WS.readUTF(),i=JSON.parse(e);if(console.log("收到ws服务器的消息",i),i.your_faction)return this.setInitChess(i.your_faction),0;var s=new CheActEvt(CheActEvt.Act);if(i._invalid)return s._invalid=!0,this.showplay.dispatchEvent(s),0;if(null!=i._moveToX&&null!=i._moveToY){if(!i._actPieceid)return console.log("报错：接收到服务器传来无pieceid的移动命令，请修改代码"),0;var o=this.pieces_set[i._actPieceid],n=o.get_property("m_x"),r=o.get_property("m_y");this.Map[n][r]=null,o.move(i._moveToX,i._moveToY),this.Map[i._moveToX][i._moveToY]=i._actPieceid,s._actPieceid=i._actPieceid,s._moveToX=i._moveToX,s._moveToY=i._moveToY}if(i._dyingPieceid){var o=this.pieces_set[i._dyingPieceid];o.kill_self(),s._dyingPieceid=i._dyingPieceid}if(i._revivePieceid){var o=this.pieces_set[i._revivePieceid];o.revive_self();var h=o.get_property("m_x"),_=o.get_property("m_y");this.Map[h][_]=i._revivePieceid,s._revivePieceid=i._revivePieceid}i._change_faction&&(this.change_faction(),s._change_faction=!0),i._winner&&(s._gameover=!0,s._winner=i._winner),this.showplay.dispatchEvent(s)},e}(egret.DisplayObject);__reflect(LogicPlay.prototype,"LogicPlay");var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){var t=new LogicPlay,e=new ShowPlay(t);t.bind(e),this.addChild(e),t.startone()},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var CheActEvt=function(t){function e(e,i,s){void 0===i&&(i=!1),void 0===s&&(s=!1);var o=t.call(this,e,i,s)||this;return o._change_faction=!1,o._invalid=!1,o._gameover=!1,o}return __extends(e,t),e}(egret.Event);CheActEvt.Act="act",__reflect(CheActEvt.prototype,"CheActEvt");var ChessBoardSite=function(t){function e(e,i,s,o){var n=t.call(this)||this;return n.m_x=s,n.m_y=o,n.graphics.beginFill(16711680,1),n.graphics.drawCircle(0,0,16),n.graphics.endFill(),n.x=e,n.y=i,n.alpha=0,n.touchEnabled=!0,n.addEventListener(egret.TouchEvent.TOUCH_TAP,n.ontap,n),n}return __extends(e,t),e.prototype.ontap=function(t){console.log("you have tap a ChessBoardSite",this.m_x,this.m_y);var e=new CheInpEvt(CheInpEvt.Tap);e._moveToX=this.m_x,e._moveToY=this.m_y,this.parent.dispatchEvent(e)},e.prototype.shining=function(t){"on"==t?this.alpha=.5:this.alpha=0},e}(egret.Shape);__reflect(ChessBoardSite.prototype,"ChessBoardSite");var CheInpEvt=function(t){function e(e,i,s){return void 0===i&&(i=!1),void 0===s&&(s=!1),t.call(this,e,i,s)||this}return __extends(e,t),e}(egret.Event);CheInpEvt.Tap="Tap",__reflect(CheInpEvt.prototype,"CheInpEvt");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Normal_Button=function(t){function e(){var e=t.call(this)||this;return e.size=49,e.textAlign=egret.HorizontalAlign.CENTER,e.verticalAlign=egret.VerticalAlign.MIDDLE,e.textColor=16744192,e.text="按钮",e.touchEnabled=!0,e.event_key="",e.addEventListener(egret.TouchEvent.TOUCH_TAP,e.ontap,e),e}return __extends(e,t),e.prototype.ontap=function(t){var e=new CheInpEvt(CheInpEvt.Tap);e[this.event_key]=!0,this.parent.dispatchEvent(e)},e}(egret.TextField);__reflect(Normal_Button.prototype,"Normal_Button");var Giveup_Button=function(t){function e(){var e=t.call(this)||this;return e.text="认输",e.event_key="_giveup",e}return __extends(e,t),e}(Normal_Button);__reflect(Giveup_Button.prototype,"Giveup_Button");var Undo_Button=function(t){function e(){var e=t.call(this)||this;return e.text="悔棋",e.event_key="_undo",e}return __extends(e,t),e}(Normal_Button);__reflect(Undo_Button.prototype,"Undo_Button");var Piece=function(t){function e(e,i,s,o,n,r,h){var _=t.call(this)||this;h&&(_.p_id=h),_.m_x=n,_.m_y=r,_.p_role=e,_.p_faction=i;var a=RES.getRes(i+"_"+e+"_png");return _.texture=a,_.width=50,_.height=50,_.anchorOffsetX=_.width/2,_.anchorOffsetY=_.height/2,_.x=s,_.y=o,_.touchEnabled=!0,_.addEventListener(egret.TouchEvent.TOUCH_TAP,_.ontap,_),_}return __extends(e,t),e.prototype.set_p_id=function(t){this.p_id=t},e.prototype.move=function(t,e,i,s){this.m_x=t,this.m_y=e,this.x=i,this.y=s},e.prototype.kill_self=function(){this.visible=!1},e.prototype.revive_self=function(){this.visible=!0},e.prototype.ontap=function(t){var e=new CheInpEvt(CheInpEvt.Tap);e._pieceID=this.p_id,e._faction=this.p_faction,this.parent.dispatchEvent(e)},e.prototype.picking_up=function(){console.log("piece picking_up"),egret.Tween.get(this,{loop:!0}).to({scaleX:1.3,scaleY:1.3},1e3,egret.Ease.backIn)},e.prototype.put_down=function(){console.log("piece put_down"),egret.Tween.removeTweens(this),this.scaleX=1,this.scaleY=1},e}(egret.Bitmap);__reflect(Piece.prototype,"Piece");var ShowPlay=function(t){function e(e){var i=t.call(this)||this;return e&&i.bind(e),i}return __extends(e,t),e.prototype.bind=function(t){this.logic=t},e.prototype.startone=function(){if(!this.logic)return console.log("logic与show必须互相绑定"),0;if(this.removeChildren(),this.human_faction=this.logic.get_property("human_faction"),"r"==this.human_faction)var t=new ChessBoardBed(!0);else var t=new ChessBoardBed;this.addChild(t),t.gene_sites_points(),this.sites_tab=new Array;for(var e=0;e<t.sites_points.length;e++){this.sites_tab[e]=new Array;for(var i=0;i<t.sites_points[e].length;i++){var s=t.sites_points[e][i],o=new ChessBoardSite(s[0],s[1],e,i);this.addChild(o),this.sites_tab[e][i]=o}}var n=new Undo_Button;this.addChild(n),n.x=t.x+t.width/2,n.y=t.y+t.height/2-100;var r=new Giveup_Button;this.addChild(r),r.x=t.x+t.width/2,r.y=t.y+t.height/2-200,this.pieces_set={};for(var h=this.logic.get_property("initMap"),_=0,a=0;a<h.length;a++)for(var c=0;c<h[a].length;c++)if(h[a][c]){var p=new Piece(h[a][c][0],h[a][c][1],t.sites_points[a][c][0],t.sites_points[a][c][1],a,c);p.set_p_id("p_"+_),this.addChild(p),this.pieces_set["p_"+_]=p,_+=1}this.active_faction=this.logic.get_property("active_faction"),this.addEventListener(CheInpEvt.Tap,this.tra_CheInp,this),this.addEventListener(CheActEvt.Act,this.do_Action,this)},e.prototype.tra_CheInp=function(t){if(t._undo||t._giveup)this.logic.dispatchEvent(t);else if(t._pieceID&&t._faction)if(t._faction==this.active_faction)t._pieceID==this.active_pieceId?(this.active_pieceId=null,this.pieces_set[t._pieceID].put_down(),this.shine_sites("off")):(this.active_pieceId&&this.pieces_set[this.active_pieceId].put_down(),this.active_pieceId=t._pieceID,this.pieces_set[this.active_pieceId].picking_up(),this.logic.dispatchEvent(t));else{if(this.active_pieceId){var e=this.pieces_set[t._pieceID];t._moveToX=e.m_x,t._moveToY=e.m_y,t._pieceID=this.active_pieceId,t._faction=this.pieces_set[t._pieceID].p_faction,this.logic.dispatchEvent(t)}this.calm_down()}else null!=t._moveToX&&null!=t._moveToY?(console.log("得到一个位点的点击消息"),this.active_pieceId&&(t._pieceID=this.active_pieceId,this.logic.dispatchEvent(t))):(console.log("得到棋盘空白的点击消息"),this.calm_down())},e.prototype.adjustByLogic=function(){this.human_faction=this.logic.get_property("human_faction"),this.active_faction=this.logic.get_property("active_faction")},e.prototype.do_Action=function(t){return console.log("收到逻辑层的消息",t),t._adjust&&(console.log("收到了逻辑层传来的矫正的命令"),this.adjustByLogic()),t._reset?(console.log("收到了逻辑层传来的再来一局的命令"),this.startone(),0):t._invalid?(this.calm_down(),0):(t._effectSites&&this.shine_sites("on",t._effectSites),null!=t._moveToX&&null!=t._moveToY&&(this.movepiece(t._actPieceid,t._moveToX,t._moveToY),this.calm_down()),t._dyingPieceid&&(this.pieces_set[t._dyingPieceid].kill_self(),this.calm_down()),t._change_faction&&this.change_faction(),t._revivePieceid&&this.pieces_set[t._revivePieceid].revive_self(),void(t._gameover&&this.game_over(t._winner)))},e.prototype.change_faction=function(t){t?this.active_faction=t:"r"==this.active_faction?this.active_faction="b":this.active_faction="r"},e.prototype.calm_down=function(){this.active_pieceId&&(this.pieces_set[this.active_pieceId].put_down(),this.active_pieceId=null),this.shine_sites("off")},e.prototype.shine_sites=function(t,e){if("on"==t){if(!e)return 0;if(this.shining_points_list)for(var i=0,s=this.shining_points_list;i<s.length;i++){var o=s[i];this.sites_tab[o[0]][o[1]].shining("off")}this.shining_points_list=e;for(var n=0,r=this.shining_points_list;n<r.length;n++){var o=r[n];this.sites_tab[o[0]][o[1]].shining("on")}}else{if(this.shining_points_list)for(var h=0,_=this.shining_points_list;h<_.length;h++){var o=_[h];this.sites_tab[o[0]][o[1]].shining("off")}this.shining_points_list=null}},e.prototype.movepiece=function(t,e,i){var s=this.sites_tab[e][i];this.pieces_set[t].move(e,i,s.x,s.y)},e.prototype.game_over=function(t){if(!t)return console.log("显示层收到逻辑层的gameover消息但没有winner"),this.calm_down(),0;console.log("胜负已分");var e=new egret.Shape;e.graphics.beginFill(8947848),e.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),e.graphics.endFill(),e.alpha=.5,e.touchEnabled=!0,this.addChild(e);var i=new egret.TextField;this.addChild(i),i.x=this.stage.width/2,i.y=this.stage.height/2,i.fontFamily="KaiTi","r"==t?i.text="红方获胜！":"b"==t?i.text="黑方获胜！":i.text="平局！！";var s=new egret.TextField;this.addChild(s),s.x=i.x,s.y=i.y+100,s.text="再来一局",s.touchEnabled=!0,s.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){console.log("点击了再来一局",this);var t=new CheInpEvt(CheInpEvt.Tap);t._reset=!0,this.logic.dispatchEvent(t)},this)},e}(egret.DisplayObjectContainer);__reflect(ShowPlay.prototype,"ShowPlay");